# Clhoria å­¦ä¹ è®¡åˆ’æ›´æ–°æ—¥å¿—

## ğŸ“… v1.1 - 2025-12-17

### æ›´æ–°æ¦‚è¿°
åŸºäº Clhoria Template v1.0.0 å®é™…é¡¹ç›®åˆ†æå’Œ CLAUDE.md è§„èŒƒï¼Œå¯¹å­¦ä¹ è®¡åˆ’è¿›è¡Œå…¨æ–¹ä½ä¼˜åŒ–ã€‚

---

## âœ¨ ä¸»è¦æ”¹è¿›

### 1. æŠ€æœ¯æ ˆç²¾ç¡®åŒ–
- **ç²¾ç¡®ç‰ˆæœ¬å·**: æ˜ç¡®æ‰€æœ‰ä¾èµ–ç‰ˆæœ¬ï¼ˆHono 4.10.7ã€TypeScript 5.9.3ã€Drizzle 0.45.0 ç­‰ï¼‰
- **æ–°å¢é¡¹ç›®ç‰¹æ€§**: è¡¥å…… pg-bossã€cronerã€Cap.jsã€Pino ç­‰å®é™…ä½¿ç”¨çš„åº“
- **æŠ€æœ¯æ ˆåŒ¹é…éªŒè¯è¡¨**: ç›´è§‚å±•ç¤ºè®¡åˆ’ä¸å®é™…çš„ 100% åŒ¹é…åº¦

### 2. é˜¶æ®µ2ï¼šæ ¸å¿ƒæŠ€æœ¯æ ˆï¼ˆå¢åŠ  1 å¤©ï¼‰

#### ğŸ†• æ–°å¢ Refine Query ç³»ç»Ÿå­¦ä¹ 
è¿™æ˜¯ Clhoria çš„**æ ¸å¿ƒåˆ›æ–°ç‰¹æ€§**ï¼ŒåŸè®¡åˆ’æœªå……åˆ†æ¶µç›–ï¼š

```typescript
// å®é™…é¡¹ç›®ä¸­çš„å®Œæ•´ä½¿ç”¨ç¤ºä¾‹
export const list: SystemUsersRouteHandlerType<"list"> = async (c) => {
  const parseResult = RefineQueryParamsSchema.safeParse(c.req.query());
  const [error, result] = await executeRefineQuery({
    table: systemUsers,
    queryParams: parseResult.data,
    joinConfig: {
      joins: [
        { table: systemUserRoles, type: "left", on: eq(...) },
        { table: systemRoles, type: "left", on: eq(...) }
      ],
      selectFields: {
        id: systemUsers.id,
        username: systemUsers.username,
        roles: sql`json_agg(...)`
      },
      groupBy: [systemUsers.id]
    }
  });
  return c.json(Resp.ok(safeData), HttpStatusCodes.OK);
};
```

**è¦†ç›–å†…å®¹**:
- âœ… 24 ç§æ“ä½œç¬¦ï¼ˆ`eq`ã€`in`ã€`between`ã€`null` ç­‰ï¼‰
- âœ… å®‰å…¨éªŒè¯ï¼ˆJSON é•¿åº¦/æ·±åº¦/æ•æ„Ÿå­—æ®µï¼‰
- âœ… å¤šè¡¨ JOIN é…ç½®
- âœ… åˆ†é¡µæ¨¡å¼ï¼ˆ`server` / `client` / `off`ï¼‰
- âœ… æ•æ„Ÿå­—æ®µè¿‡æ»¤

#### ğŸ¯ ä¸‰å¤§æ ¸å¿ƒè§„åˆ™å¼ºåŒ–
```typescript
// 1. å“åº”åŒ…è£…ï¼ˆå¼ºåˆ¶ï¼‰
return c.json(Resp.ok(data), HttpStatusCodes.OK);  // âœ…
return c.json(data, HttpStatusCodes.OK);            // âŒ

// 2. æ—¥å¿—æ ¼å¼ï¼ˆä¸¥æ ¼ï¼‰
logger.info({ userId }, "[ç”¨æˆ·]: ç™»å½•æˆåŠŸ");        // âœ…
logger.info("ç”¨æˆ·ç™»å½•:", userId);                   // âŒ

// 3. ç±»å‹çº¦æŸï¼ˆç²¾ç¡®ï¼‰
export const list: FeatureRouteHandlerType<"list"> = async (c) => {};  // âœ…
export const list = async (c: Context) => {};                          // âŒ
```

---

### 3. é˜¶æ®µ4ï¼šæ•°æ®ä¸æƒé™ï¼ˆå¢åŠ  1 å¤©ï¼‰

#### â­ æ ¸å¿ƒç†å¿µï¼šä»£ç å³æƒé™ï¼ˆCode as Permissionï¼‰

**ä¼ ç»Ÿæ–¹æ¡ˆ vs Clhoria æ–¹æ¡ˆå¯¹æ¯”**:

| ç»´åº¦ | Clhoria æ–¹æ¡ˆ | ä¼ ç»Ÿæ–¹æ¡ˆ |
|------|-------------|----------|
| æƒé™å­˜å‚¨ | OpenAPI è·¯ç”±å®šä¹‰ | æ•°æ®åº“æƒé™è¡¨ |
| ç»´æŠ¤æˆæœ¬ | æ”¹ä¸€å¤„è‡ªåŠ¨åŒæ­¥ | æ‰‹åŠ¨ç»´æŠ¤å¤šå¤„ |
| ç±»å‹å®‰å…¨ | TypeScript ç¼–è¯‘æ—¶ | è¿è¡Œæ—¶æ£€æŸ¥ |
| èœå•ç”Ÿæˆ | è‡ªåŠ¨ç”Ÿæˆ | æ•°æ®åº“å­˜å‚¨ |

**å®ç°æœºåˆ¶**:
```
OpenAPI è·¯ç”±å®šä¹‰ â†’ Casbin KeyMatch3 åŒ¹é… â†’ æƒé™éªŒè¯
     â†‘
     â””â”€â”€ æ— éœ€æ•°æ®åº“å­˜å‚¨æƒé™æ ‡è¯†
```

**é‡ç‚¹å­¦ä¹ **:
1. JWT åŒå¯†é’¥éš”ç¦»ï¼ˆ`ADMIN_JWT_SECRET` / `CLIENT_JWT_SECRET`ï¼‰
2. Casbin RBAC + KeyMatch3 è·¯å¾„åŒ¹é…
3. æƒé™ç¼“å­˜ä¼˜åŒ–ï¼ˆRedisï¼‰
4. PostgreSQL Enum + Drizzle-Zod + OpenAPI åŒæ­¥

---

### 4. é˜¶æ®µ5ï¼šè´¨é‡ä¿éšœï¼ˆå¢åŠ  1 å¤©ï¼‰

#### ğŸ“‹ ä¸¥æ ¼çš„æ—¥å¿—è§„èŒƒ
```typescript
// âœ… æ­£ç¡®æ ¼å¼
logger.info({ userId }, "[ç”¨æˆ·]: ç™»å½•æˆåŠŸ");
logger.error(error, "[ç³»ç»Ÿ]: åˆå§‹åŒ–å¤±è´¥");
logger.warn({ field }, "[æŸ¥è¯¢]: è®¿é—®æ•æ„Ÿå­—æ®µ");

// âŒ ä¸¥ç¦ä½¿ç”¨
console.log("ç”¨æˆ·ç™»å½•:", userId);
logger.info("æ•°æ®:", data);  // æ•°æ®å¿…é¡»åœ¨å‰
logger.info("[æ¨¡å—]: æ•°æ®:", data);  // æ•°æ®å¿…é¡»åœ¨å‰å¯¹è±¡
```

**å…³é”®è§„åˆ™**:
- æ•°æ®å¯¹è±¡åœ¨å‰ï¼Œæè¿°åœ¨å
- æ ¼å¼ï¼š`[æ¨¡å—å]: æè¿°`
- æ—  emoji / è‹±æ–‡
- 25% è¿›åº¦é—´éš”è®°å½•
- æ•æ„Ÿå­—æ®µè‡ªåŠ¨æ£€æµ‹

#### ğŸ§ª Zod v4 Schema æ¨¡å¼
```typescript
// Schema ç»§æ‰¿æ¨¡å¼
const selectSchema = createSelectSchema(table, {
  field: schema => schema.meta({ description: "æè¿°" })
});
const insertSchema = createInsertSchema(table).omit({ id: true });
const patchSchema = insertSchema.partial();
```

---

### 5. é˜¶æ®µ6ï¼šç”Ÿäº§éƒ¨ç½²ï¼ˆå¢åŠ  1 å¤©ï¼‰

#### ğŸ†• æ–°å¢ä»»åŠ¡é˜Ÿåˆ—ä¸å®šæ—¶ä»»åŠ¡

**pg-boss åå°ä»»åŠ¡é˜Ÿåˆ—**ï¼ˆåŸºäº PostgreSQLï¼‰:
```typescript
// æ— éœ€é¢å¤–æœåŠ¡ï¼Œç›´æ¥ä½¿ç”¨æ•°æ®åº“
await dbBoss.insert('queue-name', { data });
```

**croner å®šæ—¶ä»»åŠ¡**:
```typescript
const job = new Cron("0 0 * * *", async () => {
  logger.info("[å®šæ—¶ä»»åŠ¡]: æ¯æ—¥æ•°æ®æ¸…ç†å¼€å§‹");
});
```

#### ğŸ†• ç‰¹è‰²åŠŸèƒ½å­¦ä¹ 
1. **Cap.js éªŒè¯ç ç³»ç»Ÿ**ï¼šæ›¿ä»£ svg-captchaï¼Œæ›´å®‰å…¨
2. **S3 å¯¹è±¡å­˜å‚¨**ï¼šæ”¯æŒ R2ã€OSSã€S3
3. **å£°æ˜å¼åˆ†é¡µå™¨**ï¼šæ‰©å±•æ”¯æŒåç«¯è”è¡¨æŸ¥è¯¢
4. **ç±»å‹å®‰å…¨å­—å…¸**ï¼šPostgreSQL Enum â†’ å‰åç«¯åŒæ­¥

---

### 6. é™„å½• - å¿«é€Ÿå‚è€ƒ

#### A. é¡¹ç›®æ¶æ„é€ŸæŸ¥è¡¨
```
src/
â”œâ”€â”€ db/schema/_shard/base-columns.ts  # åŸºç¡€åˆ—ï¼ˆpg18+ï¼‰
â”œâ”€â”€ lib/refine-query/                 # å£°æ˜å¼æŸ¥è¯¢ç³»ç»Ÿ â­
â”œâ”€â”€ routes/
â”‚   â”œâ”€â”€ public/                       # æ— è®¤è¯
â”‚   â”œâ”€â”€ client/                       # JWT
â”‚   â””â”€â”€ admin/                        # JWT + RBAC
â””â”€â”€ services/                         # å¤ç”¨â‰¥2æ¬¡æ‰åˆ›å»º
```

#### B. æ ¸å¿ƒæµç¨‹é€ŸæŸ¥
- **è®¤è¯æµç¨‹**: ç™»å½• â†’ éªŒè¯ç  â†’ JWT â†’ åŒ Token â†’ Cookie
- **Refine Query**: å‚æ•°éªŒè¯ â†’ å®‰å…¨æ£€æŸ¥ â†’ JOIN â†’ åˆ†é¡µ â†’ è¿”å›
- **æƒé™æµç¨‹**: OpenAPI â†’ JWT â†’ Casbin KeyMatch3 â†’ Redis â†’ æˆæƒ

#### C. ä¸‰å¤§æ ¸å¿ƒè§„åˆ™æ£€æŸ¥æ¸…å•
```markdown
- [ ] æ˜¯å¦ä½¿ç”¨ Resp.ok()/Resp.fail()ï¼Ÿ
- [ ] æ—¥å¿—æ ¼å¼æ˜¯å¦ logger.info({data}, "[æ¨¡å—]: æè¿°")ï¼Ÿ
- [ ] Handler æ˜¯å¦ä½¿ç”¨ FeatureRouteHandlerTypeï¼Ÿ
```

#### D. æ—¶é—´é¢„ä¼°
| é˜¶æ®µ | æ—¶é—´ | ç´¯è®¡ |
|------|------|------|
| é˜¶æ®µ1ï¼šå…¥é—¨å‡†å¤‡ | 3-5 å¤© | 3-5 å¤© |
| é˜¶æ®µ2ï¼šæ ¸å¿ƒæŠ€æœ¯æ ˆ | 5-7 å¤© | 8-12 å¤© |
| é˜¶æ®µ3ï¼šæ¶æ„å®è·µ | 5-7 å¤© | 13-19 å¤© |
| é˜¶æ®µ4ï¼šæ•°æ®ä¸æƒé™ | 7-9 å¤© | 20-28 å¤© |
| é˜¶æ®µ5ï¼šè´¨é‡ä¿éšœ | 5-6 å¤© | 25-34 å¤© |
| é˜¶æ®µ6ï¼šç”Ÿäº§éƒ¨ç½² | 4-5 å¤© | 29-39 å¤© |

**æ€»è®¡ï¼š29-39 å¤©ï¼ˆçº¦ 1-1.5 ä¸ªæœˆï¼‰**

---

## ğŸ”„ ä¸åŸç‰ˆè®¡åˆ’å¯¹æ¯”

| ç»´åº¦ | åŸç‰ˆ v1.0 | æ›´æ–°ç‰ˆ v1.1 | å˜åŒ– |
|------|-----------|-------------|------|
| æ€»å¤©æ•° | 3-5+4-6+5-7+6-8+4-5+3-4  â‰ˆ 25-35 å¤© | 3-5+5-7+5-7+7-9+5-6+4-5 â‰ˆ 29-39 å¤© | +4 å¤© |
| æŠ€æœ¯æ ˆç²¾åº¦ | ç²—ç•¥ | ç²¾ç¡®åˆ°ç‰ˆæœ¬ | ğŸ”¥ |
| Refine Query | æœªçªå‡º | é˜¶æ®µ2æ ¸å¿ƒå†…å®¹ | ğŸ†• |
| ä»£ç å³æƒé™ | æœªæåŠ | é˜¶æ®µ4æ ¸å¿ƒç†å¿µ | ğŸ†• |
| ä»»åŠ¡é˜Ÿåˆ— | æ—  | é˜¶æ®µ6è¡¥å…… | ğŸ†• |
| æ—¥å¿—è§„èŒƒ | ç®€å• | ä¸¥æ ¼æ ¼å¼ + æ£€æŸ¥ | ğŸ”’ |
| é™„å½• | æ—  | 4ä¸ªé€ŸæŸ¥è¡¨ | ğŸ“š |

---

## ğŸ“– ä½¿ç”¨å»ºè®®

1. **å¯¹ç…§å­¦ä¹ **: æ¯ä¸ªé˜¶æ®µå¯¹ç…§å®é™…ä»£ç  `src/routes/` ç›®å½•
2. **å®è·µä¼˜å…ˆ**: å­¦å®Œç«‹å³åŠ¨æ‰‹å®ç°å‚è€ƒç¤ºä¾‹
3. **å®šæœŸå›é¡¾**: æ¯å‘¨å›é¡¾ CLAUDE.md ä¸‰å¤§æ ¸å¿ƒè§„åˆ™
4. **é—®é¢˜å¯¼å‘**: é‡åˆ°é—®é¢˜ â†’ CLAUDE.md â†’ æºç  â†’ å®˜æ–¹æ–‡æ¡£

---

## ğŸ’¡ å…³é”®å­¦ä¹ ç‚¹

### é˜¶æ®µ2 å¿…é¡»æŒæ¡
- Refine Query å‚æ•°æ ¼å¼å’Œå®‰å…¨éªŒè¯
- ä¸‰å¤§æ ¸å¿ƒè§„åˆ™ï¼ˆå“åº”åŒ…è£…ã€æ—¥å¿—æ ¼å¼ã€ç±»å‹çº¦æŸï¼‰

### é˜¶æ®µ4 å¿…é¡»æŒæ¡
- "ä»£ç å³æƒé™"ç†å¿µï¼ˆæƒé™æ— éœ€æ•°æ®åº“å­˜å‚¨ï¼‰
- Casbin KeyMatch3 è·¯å¾„åŒ¹é…
- JWT åŒå¯†é’¥éš”ç¦»

### é˜¶æ®µ5 å¿…é¡»æŒæ¡
- ä¸¥æ ¼çš„æ—¥å¿—æ ¼å¼
- Zod Schema ç»§æ‰¿æ¨¡å¼

---

## ğŸ¯ å®Œæˆæ ‡å‡†

å®Œæˆæ‰€æœ‰é˜¶æ®µåï¼Œä½ å°†èƒ½å¤Ÿï¼š

âœ… ç‹¬ç«‹å¼€å‘åŸºäº Clhoria çš„ä¼ä¸šçº§åç«¯åº”ç”¨
âœ… **ç†Ÿç»ƒæŒæ¡ Refine Query å£°æ˜å¼æŸ¥è¯¢ç³»ç»Ÿ**
âœ… **ç†è§£å¹¶åº”ç”¨"ä»£ç å³æƒé™"çš„åˆ›æ–°ç†å¿µ**
âœ… ç†Ÿç»ƒä½¿ç”¨ç°ä»£ TypeScript + Hono å¼€å‘æ¨¡å¼
âœ… æŒæ¡å®Œæ•´çš„é¡¹ç›®éƒ¨ç½²ã€ç›‘æ§å’Œè¿ç»´æµç¨‹
âœ… ç”Ÿäº§ç¯å¢ƒè°ƒè¯•å’Œæ€§èƒ½ä¼˜åŒ–

---

> ğŸ¯ **è®¾è®¡ç†å¿µï¼šåŒ–ç¹ä¸ºç®€**
> é€šè¿‡ä¸¥æ ¼çš„è§„èŒƒå’Œç°ä»£åŒ–çš„å·¥å…·é“¾ï¼Œè®©å¤æ‚çš„ä¼ä¸šçº§å¼€å‘å˜å¾—ç®€å•è€Œä¼˜é›…ã€‚

---

## ğŸ“ å¦‚æœ‰ç–‘é—®

- ä¼˜å…ˆæŸ¥çœ‹ `CLAUDE.md`ï¼ˆå¼€å‘è§„èŒƒï¼‰
- å¯¹ç…§ `src/routes/admin/system/users/`ï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰
- ä½¿ç”¨ Scalar UI åœ¨çº¿è°ƒè¯•ï¼ˆhttp://localhost:9999ï¼‰
